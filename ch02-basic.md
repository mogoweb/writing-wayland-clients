## ç¼–å†™ä¸€ä¸ªåŸºç¡€æœ¬åº”ç”¨

### è®¾ç½®ç¯å¢ƒ
è™½ç„¶æœ‰ä¸€äº›ç‹¬ç«‹çš„ Wayland å®ç°ï¼Œæ¯”å¦‚ **Skylane** å’Œ **Sudbury**ï¼Œä½†å‚è€ƒå®ç° **libwayland-client** ä¾ç„¶æ˜¯ç›®å‰æœ€æµè¡Œçš„ã€‚ä¸åŒè¯­è¨€éƒ½æœ‰å¾ˆå¤šé’ˆå¯¹ libwayland-client çš„ç»‘å®š â€”â€” ä¾‹å¦‚ Pythonã€C++ã€Rustã€Haskellï¼Œç”šè‡³è¿˜æœ‰ Objective-C â€”â€” ä¸è¿‡åœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æœ€åŸå§‹çš„ **C ç‰ˆæœ¬**ã€‚

Wayland åœ¨æŠ€æœ¯ä¸Šå¹¶ä¸é™äº Linuxï¼Œå®ƒä¹Ÿå¯ä»¥è¿è¡Œåœ¨ä»»ä½•ç±» Unix ç³»ç»Ÿä¸Šã€‚ä½†ä¸ºäº†ä¿æŒç®€å•ï¼Œæˆ‘ä»¬å°†åœ¨ Linux ä¸Šè¿›è¡Œå­¦ä¹ ã€‚

+ ä½ é¦–å…ˆéœ€è¦ä¸€ä¸ªå¯ç”¨çš„ **C ç¼–è¯‘å™¨**ã€‚æˆ‘å°†ä½¿ç”¨ **GCC**ï¼Œä½†å¦‚æœä½ æ„¿æ„ï¼Œä¹Ÿå®Œå…¨å¯ä»¥ç”¨ **Clang** æ¥ä»£æ›¿ã€‚
+ æ¥ä¸‹æ¥ï¼Œä½ éœ€è¦å®‰è£… **wayland-client** åº“ã€‚ä½ æ‰€ç”¨çš„å‘è¡Œç‰ˆå¤§æ¦‚ç‡å·²ç»æä¾›äº†è¯¥åº“ï¼Œé€šå¸¸åŒ…åæ˜¯ `wayland`ã€`libwayland-client` æˆ– `libwayland-client0`ã€‚è€Œä¸”åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œå®ƒå¯èƒ½å·²ç»å®‰è£…å¥½äº†ã€‚å¤ªæ£’äº†ã€‚
+ ä½ è¿˜éœ€è¦ **libwayland-client çš„å¼€å‘æ–‡ä»¶**ï¼Œå°¤å…¶æ˜¯ `wayland-client.h` å¤´æ–‡ä»¶ã€‚å®ƒé€šå¸¸ä¼šéšä¸Šé¢æåˆ°çš„åº“ä¸€åŒæä¾›ï¼Œæˆ–è€…å•ç‹¬å­˜åœ¨äº `wayland-devel`ã€`libwayland-dev` ä¹‹ç±»çš„åŒ…ä¸­ã€‚
+ è¦è¿è¡Œä½ çš„ç¨‹åºï¼Œä½ éœ€è¦ä¸€ä¸ªå¯ç”¨çš„ **Wayland åˆæˆå™¨ï¼ˆcompositorï¼‰**ã€‚åƒ Archã€Fedoraï¼ˆè‡ª 25 ç‰ˆèµ·ï¼‰ã€Ubuntuï¼ˆè‡ª 17.10 èµ·ï¼‰è¿™æ ·çš„ä¸»æµå‘è¡Œç‰ˆï¼Œé»˜è®¤éƒ½æä¾›äº†åŸºäº Wayland çš„ GNOMEï¼Œæ‰€ä»¥å¦‚æœä½ ä½¿ç”¨è¿™äº›å‘è¡Œç‰ˆï¼Œä¸€åˆ‡åº”è¯¥å¼€ç®±å³ç”¨ã€‚å¦åˆ™ï¼Œè·å– Wayland åˆæˆå™¨æœ€ç®€å•çš„æ–¹æ³•æ˜¯å®‰è£… **Weston**ï¼Œå®ƒæ˜¯ Wayland çš„å‚è€ƒæœåŠ¡å™¨å®ç°ã€‚ä½ å¯ä»¥åœ¨ç‹¬ç«‹çš„ **TTY** ä¸Šè¿è¡Œ Westonï¼Œä¹Ÿå¯ä»¥ä½œä¸º X ä¸‹çš„ä¸€ä¸ªçª—å£è¿è¡Œã€‚å¦‚æœé€‰æ‹©åè€…ï¼Œè¯·ç¡®ä¿ä»åˆæˆå™¨å†…è¿è¡Œçš„ç»ˆç«¯æ¨¡æ‹Ÿå™¨ä¸­å¯åŠ¨ä½ çš„ç¨‹åºï¼Œä»¥ä¾¿å®ƒèƒ½æ­£ç¡®è·å–æ‰€éœ€çš„ç¯å¢ƒå˜é‡ï¼ˆæˆ–è€…ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨è®¾ç½®å®ƒä»¬ï¼‰ã€‚

æ³¨ï¼š

+ deepin Linux çš„ TreeLand æ˜¯åŸºäº Wayland çš„çª—å£ç®¡ç†å™¨ï¼Œæœ¬æ–‡æ‰€æœ‰ä»£ç å‡åœ¨ deepin Linux  V25 ä¸‹éªŒè¯é€šè¿‡ã€‚
+ åœ¨ deepin Linux ä¸Šä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å®‰è£…å¼€å‘æ‰€éœ€è¦çš„åº“å’Œå¤´æ–‡ä»¶ï¼š

```plain
$ sudo apt install libwayland-dev build-essential
```
+ å¦‚æœåœ¨ deepin Linux ä¸‹ä¸åˆ‡æ¢åˆ° Treelandï¼Œå¯ä»¥å¯åŠ¨ weston ç¨‹åºï¼Œç„¶åè¿è¡Œ Wayland å®¢æˆ·ç«¯ç¨‹åºï¼š

```
$ weston &
$ WAYLAND_DISPLAY=wayland-1 ./my-wayland-app
```

### ç¬¬ä¸€æ­¥
æˆ‘ä»¬å…ˆæŠŠä¸‹é¢çš„ä»£ç å†™åˆ° **main.c** é‡Œï¼š

```c
#include <stdio.h>
#include <wayland-client.h>

int main(void)
{
    struct wl_display *display = wl_display_connect(NULL);
    if (display) {
        printf("Connected!\n");
    } else {
        printf("Error connecting ;(\n");
        return 1;
    }

    wl_display_disconnect(display);
    return 0;
}
```

ç”¨ä¸‹é¢çš„å‘½ä»¤ç¼–è¯‘å¹¶è¿è¡Œï¼š

```bash
$ gcc main.c -l wayland-client -o runme
$ ./runme
Connected!
```

**æ­å–œï¼** æˆ‘ä»¬å·²ç»æˆåŠŸå†™å‡ºäº†ç¬¬ä¸€ä¸ª Wayland ç¨‹åºã€‚

### Wayland çš„åŸºæœ¬åŸç†
Wayland æ˜¯ä¸€ç§ **å®¢æˆ·ç«¯-æœåŠ¡å™¨åè®®**ã€‚æƒ³è¦åœ¨å±å¹•ä¸Šæ˜¾ç¤ºå›¾å½¢çš„å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚éœ€è¦å±•ç¤ºå›¾å½¢ç•Œé¢çš„åº”ç”¨ç¨‹åºï¼‰ï¼Œä¼šè¿æ¥å¹¶ä¸æœåŠ¡å™¨é€šä¿¡ã€‚æœåŠ¡å™¨ä¹Ÿè¢«ç§°ä¸º **Wayland åˆæˆå™¨ï¼ˆcompositorï¼‰**ï¼Œå› ä¸ºå®ƒè´Ÿè´£å°†å®¢æˆ·ç«¯çš„å†…å®¹ï¼ˆä¾‹å¦‚å¤šä¸ªçª—å£ï¼‰ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆæœ€ç»ˆè¾“å‡ºå¹¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚

åˆæˆå™¨è¿˜å¯èƒ½ä¼šå¯¹å®¢æˆ·ç«¯çš„å†…å®¹åº”ç”¨ä¸€äº›å˜æ¢ã€‚ä¾‹å¦‚ï¼Œå®ƒå¯èƒ½ä¼šç¼©æ”¾çª—å£ï¼Œç”šè‡³åœ¨ä¸‰ç»´ç©ºé—´ä¸­æ—‹è½¬çª—å£ï¼Œä»¥å®ç°æŸç§â€œæ¦‚è§ˆæ¨¡å¼â€ï¼›æˆ–è€…åº”ç”¨ä¸€äº›é…·ç‚«çš„æ•ˆæœï¼Œæ¯”å¦‚â€œæ™ƒåŠ¨çš„çª—å£â€ã€‚ä¸è¿‡è¿™äº›éƒ½ä¸å®¢æˆ·ç«¯æ— å…³ï¼šå®¢æˆ·ç«¯å®Œå…¨ä¸çŸ¥é“åˆæˆå™¨å¯¹å®ƒä»¬æä¾›çš„å†…å®¹åšäº†å“ªäº›å˜æ¢ã€‚

Wayland åˆ†ä¸ºå¤šä¸ªå±‚æ¬¡ã€‚  
**çº¿ç¼†æ ¼å¼ï¼ˆWire formatï¼‰** è§„å®šäº†æ•°æ®æ˜¯å¦‚ä½•è¢«åºåˆ—åŒ–ã€ä¼ è¾“å’Œååºåˆ—åŒ–çš„ã€‚ç”±äºæˆ‘ä»¬ä¼šä½¿ç”¨æŠ½è±¡æ‰è¿™äº›ç»†èŠ‚çš„åº“ï¼Œæ‰€ä»¥è¿™é‡Œä¸éœ€è¦å…³å¿ƒè¿™äº›å®ç°ç»†èŠ‚ã€‚

çº¿ç¼†æ ¼å¼è¿˜è§„å®šäº†é€šä¿¡æ˜¯é€šè¿‡ **Unix åŸŸå¥—æ¥å­—æµ** å®Œæˆçš„ã€‚å¥—æ¥å­—é€šå¸¸ä½äºç±»ä¼¼ `/run/user/1000/wayland-0` çš„è·¯å¾„ï¼ˆæ›´å‡†ç¡®åœ°è¯´æ˜¯ `$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY`ï¼‰ã€‚å¥—æ¥å­—ç”±æœåŠ¡å™¨åˆ›å»ºï¼Œé€šå¸¸æ˜¯åœ¨å®ƒå¯åŠ¨æ—¶åˆ›å»ºã€‚å› ä¸ºå¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯æœåŠ¡å™¨æ´¾ç”Ÿï¼ˆforkï¼‰å‡ºå®¢æˆ·ç«¯ï¼Œæ‰€ä»¥å®ƒé€šå¸¸ä¼šä¸ºå®¢æˆ·ç«¯è®¾ç½®å¥½ `WAYLAND_DISPLAY` ç¯å¢ƒå˜é‡ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯çŸ¥é“è¯¥è¿æ¥åˆ°å“ªé‡Œã€‚

æ¥ä¸‹æ¥ï¼ŒWayland å®šä¹‰äº† **å¯¹è±¡æ¨¡å‹**ã€‚Wayland æ˜¯ **é¢å‘å¯¹è±¡** çš„ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„æ‰€æœ‰é€šä¿¡éƒ½ä»¥åœ¨æŸäº›å¯¹è±¡ä¸Šè°ƒç”¨æ–¹æ³•çš„å½¢å¼æ¥è¡¨è¾¾ã€‚è¿™äº›å¯¹è±¡åªæ˜¯å‡ºäºç†è§£æ–¹ä¾¿çš„æŠ½è±¡ï¼Œæœ¬èº«å¹¶ä¸å­˜åœ¨â€”â€”ä¸è¿‡å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å¯èƒ½ä¼šä¿å­˜ä¸€äº›å…³äºå®ƒä»¬çš„å…ƒæ•°æ®ã€‚

å¯¹è±¡çš„æ–¹æ³•åˆ†ä¸ºä¸¤ç±»ï¼š**è¯·æ±‚ï¼ˆrequestsï¼‰** å’Œ **äº‹ä»¶ï¼ˆeventsï¼‰**ã€‚

+ è¯·æ±‚æ˜¯ç”±å®¢æˆ·ç«¯è°ƒç”¨çš„æ–¹æ³•ã€‚
+ äº‹ä»¶æ˜¯ç”±æœåŠ¡å™¨å‘å‡ºçš„ã€‚

ä¾‹å¦‚ï¼Œä¸€ä¸ª `wl_pointer` å¯¹è±¡æœ‰ `wl_pointer.set_cursor` è¯·æ±‚ï¼ˆä¿®æ”¹å…‰æ ‡å›¾åƒï¼‰ï¼Œä»¥åŠ `wl_pointer.motion` äº‹ä»¶ï¼ˆè¡¨ç¤ºæŒ‡é’ˆç§»åŠ¨ï¼‰ã€‚

æ— è®ºæ˜¯è¯·æ±‚è¿˜æ˜¯äº‹ä»¶ï¼Œéƒ½å¯ä»¥åƒç¼–ç¨‹è¯­è¨€ä¸­çš„å‡½æ•°/æ–¹æ³•è°ƒç”¨ä¸€æ ·ï¼Œæºå¸¦é¢å¤–çš„æ•°æ®ï¼ˆå‚æ•°ï¼‰ã€‚ä¾‹å¦‚ï¼Œ`wl_pointer.motion` äº‹ä»¶ä¼šæºå¸¦æ—¶é—´å’Œä¸¤ä¸ªåæ ‡å‚æ•°ã€‚

ä½†æ˜¯ï¼ŒWayland ä¸­çš„æ–¹æ³•æ—¢æ²¡æœ‰è¿”å›å€¼ï¼Œä¹Ÿæ²¡æœ‰å“åº”æœºåˆ¶ã€‚æ¢å¥è¯è¯´ï¼Œæ²¡æœ‰åŠæ³•ä»æ–¹æ³•è°ƒç”¨ä¸­å¾—åˆ°ç›´æ¥è¿”å›ç»“æœã€‚è¦ç†è§£åŸå› ï¼Œéœ€è¦å…ˆæŒæ¡ä»¥ä¸‹ä¸‰ä¸ªç›¸å…³æ¦‚å¿µï¼š

1. **Wayland æ˜¯åŸºäºæ¶ˆæ¯çš„**ã€‚  
æ–¹æ³•è°ƒç”¨ä¼šä»¥æ¶ˆæ¯çš„å½¢å¼åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ è¾“ï¼ˆæ–¹å‘å–å†³äºæ˜¯è¯·æ±‚è¿˜æ˜¯äº‹ä»¶ï¼‰ã€‚ä¸€ä¸ªæ¶ˆæ¯åŒ…å«å¯¹è±¡çš„ IDã€æ–¹æ³•çš„æ“ä½œç ï¼ˆå³é™æ€å·²çŸ¥çš„ IDï¼‰ä»¥åŠå‚æ•°ã€‚æ¶ˆæ¯å†…å®¹çš„å…·ä½“å¸ƒå±€ç”±çº¿ç¼†æ ¼å¼è§„å®šã€‚
2. **å‘é€æ¶ˆæ¯ä¸ä¼šé˜»å¡å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨**ã€‚  
æ¢å¥è¯è¯´ï¼Œæ²¡æœ‰å¾€è¿”å»¶è¿Ÿï¼ˆroundtrip delayï¼‰ã€‚é¿å…å¾€è¿”å»¶è¿Ÿæ˜¯ Wayland è®¾è®¡çš„ç›®æ ‡ä¹‹ä¸€ï¼Œå› ä¸ºå¾€è¿”å»¶è¿Ÿä¼šä¸¥é‡æ‹–æ…¢é€šä¿¡ã€‚Wayland çš„ç›®æ ‡æ˜¯ä¿æŒæé«˜çš„é€Ÿåº¦å’Œæ•ˆç‡ã€‚
3. **å› æ­¤ï¼ŒWayland æ˜¯å¼‚æ­¥çš„**ã€‚  
å½“ä½ è°ƒç”¨ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå¯ä»¥ç«‹å³ç»§ç»­æ‰§è¡Œï¼Œè€Œä¸ä¼šå¾—åˆ°è¿”å›å€¼æˆ–ç¡®è®¤ã€‚å¦‚æœæŸä¸ªæ–¹æ³•åœ¨é€»è¾‘ä¸Šéœ€è¦å“åº”ï¼Œå®ƒé€šå¸¸ä¼šé€šè¿‡å¦ä¸€ç§æ–¹æ³•è°ƒç”¨æ¥å®ç°ã€‚ä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç”¨ `wl_shell_surface.set_fullscreen` è¯·æ±‚è¦æ±‚ä¸€ä¸ªçª—å£å…¨å±åŒ–ï¼Œåˆæˆå™¨éšåä¼šé€šè¿‡ `wl_shell_surface.configure` äº‹ä»¶å›åº”ï¼Œå¹¶ä¼ é€’æ–°çš„çª—å£å°ºå¯¸ï¼ˆå³å±å¹•å¤§å°ï¼‰ã€‚

å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„é€»è¾‘ä¹Ÿå¿…é¡»æ˜¯å¼‚æ­¥çš„ã€‚æ¯”å¦‚ `set_fullscreen` å’Œ `configure` ä¹‹é—´çš„å»¶è¿Ÿï¼Œå¯èƒ½ä¸ä»…ä»…æ˜¯å¤„ç†æ—¶é—´çš„å¼€é”€ï¼Œè¿˜å¯èƒ½æ¶‰åŠç”¨æˆ·äº¤äº’ï¼ˆæœåŠ¡å™¨å¯èƒ½ä¼šå…ˆè¯¢é—®ç”¨æˆ·æ˜¯å¦å…è®¸çª—å£å…¨å±ï¼‰ã€‚å› æ­¤ï¼Œå®¢æˆ·ç«¯åº”è¯¥æŠŠ `set_fullscreen` å½“ä½œä¸€ä¸ªâ€œå¸Œæœ›å°†æ¥å…¨å±â€çš„æŒ‡ç¤ºï¼Œç„¶åç»§ç»­æ­£å¸¸è¿è¡Œï¼Œå¹¶åœ¨ä»»ä½•æ—¶å€™æ¥æ”¶åˆ° `configure` äº‹ä»¶æ—¶ä½œå‡ºååº”ï¼ˆæ¯”å¦‚è°ƒæ•´çª—å£å¤§å°ï¼‰ï¼Œè€Œä¸å¿…å…³å¿ƒäº‹ä»¶å…·ä½“çš„è§¦å‘åŸå› ã€‚

å¦ä¸€ä¸ªå¸¸è§æ¨¡å¼æ˜¯ **åˆ›å»ºå¹¶è¿”å›æ–°å¯¹è±¡** çš„å‡½æ•°ã€‚è¿™å¯ä»¥ç”¨åŒæ ·çš„è¯·æ±‚/äº‹ä»¶æœºåˆ¶æ¥å®ç°ã€‚ä½†ç”±äº Wayland å¯¹è±¡æœ¬èº«ä¸å­˜å‚¨æ•°æ®ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å”¯ä¸€éœ€è¦åå•†çš„æ˜¯æ–°å¯¹è±¡çš„ **ID**ã€‚å¦‚æœè®©æœåŠ¡å™¨ç”Ÿæˆ ID å¹¶ä¼ å›å®¢æˆ·ç«¯ï¼Œå°±ä¼šäº§ç”Ÿå¾€è¿”å»¶è¿Ÿã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ Wayland ä¸­æ˜¯å®¢æˆ·ç«¯ç”Ÿæˆå¹¶ä¼ é€’æ–°å¯¹è±¡çš„ IDï¼Œä½œä¸ºåˆ›å»ºè¯·æ±‚çš„å‚æ•°äº¤ç»™æœåŠ¡å™¨ã€‚è¿™æ ·å°±é¿å…äº†ç­‰å¾…ï¼Œå®¢æˆ·ç«¯å¯ä»¥ç«‹åˆ»ç»§ç»­æ‰§è¡Œï¼Œå¹¶ä¸”é©¬ä¸Šå¯¹æ–°å¯¹è±¡å‘èµ·è¯·æ±‚ã€‚

æœ‰æ—¶ä¹Ÿä¼šåè¿‡æ¥ï¼šæŸäº›åœºæ™¯ä¸‹ä¼šæœ‰äº‹ä»¶/è¯·æ±‚å¯¹ï¼ˆä¾‹å¦‚ `wl_shell_surface.ping` å’Œ `wl_shell_surface.pong`ï¼‰ï¼›è€Œå½“æœåŠ¡å™¨åˆ›å»ºæ–°å¯¹è±¡æ—¶ï¼Œå®ƒä¼šå°†å¯¹è±¡ ID ä½œä¸ºäº‹ä»¶å‚æ•°å‘é€ç»™å®¢æˆ·ç«¯ã€‚

æœ€åï¼ŒWayland å®šä¹‰äº†ä¸€äº› **å…·ä½“çš„å¯¹è±¡ç±»å‹ï¼ˆæ¥å£ï¼‰** åŠå…¶å¯è°ƒç”¨çš„æ–¹æ³•ï¼Œè¿™è¢«ç§°ä¸º **Wayland æ ¸å¿ƒåè®®**ã€‚ä¾‹å¦‚ï¼Œå­˜åœ¨ `wl_surface` æ¥å£ï¼Œå®ƒæä¾› `wl_surface.attach` è¯·æ±‚ã€‚

ä¸å‰é¢æåˆ°çš„å±‚æ¬¡ä¸åŒï¼Œæ ¸å¿ƒåè®®æ˜¯ **å¯æ‰©å±•** çš„ï¼Œå¯ä»¥åœ¨å…¶ä¸Šæ·»åŠ æ–°çš„æ¥å£ã€‚æ¯”è¾ƒè‘—åçš„æ‰©å±•æ˜¯ **xdg-shell**ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€èŠ‚è¿›è¡Œè®¨è®ºã€‚

### wayland-client åº“
å®ç° Wayland å®¢æˆ·ç«¯æœ€ç®€å•çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨å®˜æ–¹çš„ **wayland-client** åº“ã€‚å®ƒçš„ä½œç”¨ä¸»è¦æ˜¯å¸®æˆ‘ä»¬å±è”½åº•å±‚çš„ **çº¿ç¼†æ ¼å¼ï¼ˆwire formatï¼‰** ç»†èŠ‚ã€‚

è¦ä½¿ç”¨å®ƒï¼Œå…ˆåŒ…å«å¤´æ–‡ä»¶ï¼š

```c
#include <wayland-client.h>
```

ç„¶ååœ¨ç¼–è¯‘æ—¶é€šè¿‡å‚æ•° `-l wayland-client` é“¾æ¥åº“ï¼š

```bash
$ gcc main.c -l wayland-client
```

ä¸ºäº†ç®¡ç†å¯¹è±¡ï¼Œ**wayland-client** ä¼šåœ¨ä¸€äº›å‘½ååˆç†çš„ä¸é€æ˜ç»“æ„ï¼ˆopaque structuresï¼‰ä¸­ä¿å­˜ä¸å¯¹è±¡ç›¸å…³çš„å…ƒæ•°æ®ã€‚æˆ‘ä»¬å§‹ç»ˆé€šè¿‡ **æŒ‡é’ˆ** æ¥ä½¿ç”¨è¿™äº›ç»“æ„ä½“å®ä¾‹ï¼Œè€Œæ— éœ€å…³å¿ƒå†…éƒ¨ç»†èŠ‚ã€‚ä½ å¯ä»¥æŠŠè¿™äº›ç»“æ„ä½“å®ä¾‹å½“ä½œå®ƒä»¬æ‰€ä»£è¡¨çš„ Wayland å¯¹è±¡æ¥ä½¿ç”¨ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œè¯·æ±‚ï¼ˆrequestï¼‰çš„è°ƒç”¨å°±æ˜¯æ™®é€šçš„å‡½æ•°è°ƒç”¨ï¼šä¼ å…¥å¯¹è±¡æŒ‡é’ˆå’Œè¯·æ±‚å‚æ•°å³å¯ï¼š

```c
struct wl_shell_surface *shell_surface = ...;
wl_shell_surface_set_title(shell_surface, "Hello World!");
```

è¿™é‡Œæˆ‘ä»¬åœ¨ä¸€ä¸ª `wl_shell_surface` å¯¹è±¡ä¸Šè°ƒç”¨äº† `wl_shell_surface.set_title` è¯·æ±‚ã€‚è¿™ä¸ªè¯·æ±‚åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œå³ä½œä¸º UTF-8 ç¼–ç å­—ç¬¦ä¸²çš„æ–°æ ‡é¢˜ã€‚

ä¸ºäº†å“åº”æœåŠ¡å™¨å‘å‡ºçš„äº‹ä»¶ï¼ˆeventsï¼‰ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®äº‹ä»¶å¤„ç†å™¨ã€‚API éå¸¸ç›´è§‚ï¼š

```c
void surface_enter_handler(void *data, struct wl_surface *surface, struct wl_output *output)
{
    printf("enter\n");
}
void surface_leave_handler(void *data, struct wl_surface *surface, struct wl_output *output)
{
    printf("leave\n");
}

...

struct wl_surface *surface = ...;
struct wl_surface_listener listener = {
    .enter = surface_enter_handler,
    .leave = surface_leave_handler
};
wl_surface_add_listener(surface, &listener, NULL);
```

è¿™é‡Œæˆ‘ä»¬ä¸ºä¸€ä¸ª `wl_surface` å¯¹è±¡å»ºç«‹äº†äº‹ä»¶å¤„ç†å™¨ã€‚è¯¥å¯¹è±¡å¯èƒ½è§¦å‘ä¸¤ä¸ªäº‹ä»¶ï¼š`enter` å’Œ `leave`ï¼Œå®ƒä»¬éƒ½å¸¦æœ‰ä¸€ä¸ª `wl_output` ç±»å‹çš„å‚æ•°ã€‚

æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ª **listener ç»“æ„ä½“**ï¼Œé‡Œé¢å­˜æ”¾æŒ‡å‘äº‹ä»¶å¤„ç†å‡½æ•°çš„æŒ‡é’ˆï¼Œç„¶åæŠŠå®ƒçš„åœ°å€ä¼ ç»™ `add listener` å‡½æ•°ï¼ˆæ³¨æ„ï¼šè¿™ä¸ªæŒ‡é’ˆåœ¨å¯¹è±¡å­˜æ´»æœŸé—´å¿…é¡»ä¿æŒæœ‰æ•ˆï¼‰ã€‚ä¼ å…¥çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼ˆè¿™é‡Œåªæ˜¯ `NULL`ï¼‰ä¼šä½œä¸ºå¤„ç†å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•° `void *data`ã€‚å¤„ç†å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯è§¦å‘äº‹ä»¶çš„å¯¹è±¡ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ºå¤šä¸ªå¯¹è±¡è®¾ç½®åŒä¸€å¥—äº‹ä»¶å¤„ç†å™¨ã€‚å…¶ä½™å‚æ•°å°±æ˜¯äº‹ä»¶è‡ªå¸¦çš„å‚æ•°ã€‚

å½“ä¸€ä¸ªè¯·æ±‚å¸¦æœ‰ `new_id` å‚æ•°ï¼ˆå³ç”±è¯¥è¯·æ±‚åˆ›å»ºçš„æ–°å¯¹è±¡ IDï¼‰æ—¶ï¼Œç›¸å…³å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªè¡¨ç¤ºæ–°å¯¹è±¡çš„ç»“æ„ä½“æŒ‡é’ˆã€‚ä¾‹å¦‚ï¼š

```c
struct wl_shm *shm = ...;
struct wl_shm_pool *pool = wl_shm_create_pool(shm, fd, size);
```

è¿™é‡Œæˆ‘ä»¬é€šè¿‡ `wl_shm.create_pool` è¯·æ±‚æ„å»ºäº†ä¸€ä¸ªæ–°çš„ `wl_shm_pool` å¯¹è±¡ã€‚è¿™ä¸ªè¯·æ±‚æœ‰ `new_id`ã€`fd` å’Œ `size` ä¸‰ä¸ªå‚æ•°ã€‚ä¸å…¶ä¼ é€’ `new_id`ï¼Œæˆ‘ä»¬ç›´æ¥å¾—åˆ°äº†ä¸€ä¸ªæ–°çš„å¯¹è±¡æŒ‡é’ˆä½œä¸ºè¿”å›å€¼ã€‚

### å…¨å±€å¯¹è±¡
æ­£å¦‚æˆ‘ä¹‹å‰æåˆ°çš„ï¼ŒWayland æ˜¯é¢å‘å¯¹è±¡çš„ï¼Œè¿™æ„å‘³ç€å®ƒçš„æ ¸å¿ƒå°±æ˜¯å¯¹è±¡ã€‚å¯¹è±¡æœ‰ä¸åŒçš„ç±»å‹ï¼ˆç§°ä¸ºæ¥å£ï¼‰ï¼Œå…¶ä¸­ä¸€äº›ç±»å‹å¯ä»¥æœ‰å¤šä¸ªå®ä¾‹ï¼Œæ¯”å¦‚ **wl_buffer**ï¼ˆå®¢æˆ·ç«¯éœ€è¦å¤šå°‘ç¼“å†²åŒºå°±å¯ä»¥æœ‰å¤šå°‘ä¸ªï¼‰ã€‚è€Œå¦ä¸€äº›åˆ™åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼ˆè¿™ç§è®¾è®¡æ¨¡å¼ç§°ä¸ºå•ä¾‹ singletonï¼‰ï¼Œä¾‹å¦‚ **wl_compositor** åªèƒ½æœ‰ä¸€ä¸ªã€‚è¿˜æœ‰ä¸€äº›æ¥å£ä»‹äºä¸¤è€…ä¹‹é—´ï¼Œæ¯”å¦‚ **wl_output**ï¼Œé€šå¸¸ä¼šæœ‰ä¸€ç»„å›ºå®šçš„æ˜¾ç¤ºå™¨ä¸ä¹‹å¯¹åº”ã€‚

è¿™å°±å¼•å‡ºäº† **å…¨å±€å¯¹è±¡ï¼ˆglobal objectsï¼‰** çš„æ¦‚å¿µã€‚å…¨å±€å¯¹è±¡ä»£è¡¨äº†åˆæˆå™¨ï¼ˆcompositorï¼‰ä»¥åŠå…¶è¿è¡Œç¯å¢ƒçš„å±æ€§ã€‚å¤§å¤šæ•°å…¨å±€å¯¹è±¡æ˜¯ç›¸åº” API é›†çš„å…¥å£ç‚¹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ·±å…¥äº†è§£ä¸€ä¸‹ï¼Œå¹¶åˆ—å‡ºå®ƒä»¬ã€‚

æŠŠä¸‹é¢çš„ç¨‹åºä¿å­˜åˆ° `main.c`ï¼š

```c
#include <stdio.h>
#include <wayland-client.h>

void registry_global_handler
(
    void *data,
    struct wl_registry *registry,
    uint32_t name,
    const char *interface,
    uint32_t version
) {
    printf("interface: '%s', version: %u, name: %u\n", interface, version, name);
}

void registry_global_remove_handler
(
    void *data,
    struct wl_registry *registry,
    uint32_t name
) {
    printf("removed: %u\n", name);
}

int main(void)
{
    struct wl_display *display = wl_display_connect(NULL);
    struct wl_registry *registry = wl_display_get_registry(display);
    struct wl_registry_listener registry_listener = {
        .global = registry_global_handler,
        .global_remove = registry_global_remove_handler
    };
    wl_registry_add_listener(registry, &registry_listener, NULL);

    while (1) {
        wl_display_dispatch(display);
    }
}
```

ç¼–è¯‘å¹¶è¿è¡Œï¼š

```bash
$ gcc main.c -l wayland-client -o runme
$ ./runme
interface: 'wl_compositor', version: 5, name: 1
interface: 'wl_subcompositor', version: 1, name: 2
interface: 'wp_viewporter', version: 1, name: 3
interface: 'zxdg_output_manager_v1', version: 2, name: 4
interface: 'wp_presentation', version: 1, name: 5
interface: 'wp_single_pixel_buffer_manager_v1', version: 1, name: 6
interface: 'wp_tearing_control_manager_v1', version: 1, name: 7
interface: 'zwp_relative_pointer_manager_v1', version: 1, name: 8
interface: 'zwp_pointer_constraints_v1', version: 1, name: 9
interface: 'zwp_input_timestamps_manager_v1', version: 1, name: 10
interface: 'weston_capture_v1', version: 1, name: 11
interface: 'wl_data_device_manager', version: 3, name: 12
interface: 'wl_shm', version: 2, name: 13
interface: 'wl_drm', version: 2, name: 14
interface: 'wl_seat', version: 7, name: 15
interface: 'zwp_linux_dmabuf_v1', version: 4, name: 16
interface: 'zwp_linux_explicit_synchronization_v1', version: 2, name: 17
interface: 'wl_output', version: 4, name: 18
interface: 'zwp_input_panel_v1', version: 1, name: 19
interface: 'zwp_input_method_v1', version: 1, name: 20
interface: 'zwp_text_input_manager_v1', version: 1, name: 21
interface: 'xdg_wm_base', version: 5, name: 22
interface: 'weston_desktop_shell', version: 1, name: 23
^C
```

è¿™æ ·æˆ‘ä»¬å°±å†™äº†ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ `weston-info` å‘½ä»¤ã€‚ä½ éœ€è¦ç”¨ **Ctrl-C** æ¥ä¸­æ–­ç¨‹åºï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰å†™åˆé€‚çš„é€€å‡ºé€»è¾‘ã€‚

é¦–å…ˆï¼Œ**wl_display** æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å…¨å±€å•ä¾‹ï¼Œè¡¨ç¤ºæ•´ä¸ªè¿æ¥ã€‚å®ƒåœ¨å¾ˆå¤šæ–¹é¢éƒ½å¾ˆç‰¹æ®Šï¼šè¿™æ˜¯å”¯ä¸€ä¸€ä¸ªä½ ä¸éœ€è¦è‡ªå·±åˆ›å»ºçš„å¯¹è±¡ï¼Œä¸€æ—¦å»ºç«‹è¿æ¥ä½ å°±å·²ç»æ‹¥æœ‰å®ƒäº†ã€‚Wayland å®¢æˆ·ç«¯åº“é€šè¿‡ `wl_display_connect()` å‡½æ•°è¿”å›å®ƒï¼Œè¿™ä¸ªå‡½æ•°åå­—é‡Œè™½ç„¶æœ‰ â€œdisplayâ€ï¼Œä½†å®ƒå¹¶ä¸æ˜¯ `wl_display` å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ã€‚åŒæ ·ï¼Œ`wl_display_dispatch()` ä¹Ÿä¸æ˜¯ â€œwl_display.dispatchâ€ æ–¹æ³•ï¼Œè€Œä»…ä»…æ˜¯ wayland-client æä¾›çš„å‡½æ•°ã€‚

å¦ä¸€æ–¹é¢ï¼Œ`wl_display.get_registry` å°±æ˜¯çœŸæ­£çš„ Wayland è¯·æ±‚ã€‚å®ƒä½¿ç”¨äº† **new_id** æœºåˆ¶ï¼Œæˆ‘ä»¬å¾—åˆ°äº† **wl_registry** å¯¹è±¡ã€‚

**wl_registry** ä¹Ÿæ˜¯ä¸€ä¸ªå…¨å±€å•ä¾‹ã€‚å®ƒçš„ä½œç”¨æ˜¯å¹¿æ’­æ‰€æœ‰å…¶ä»–å…¨å±€å¯¹è±¡ã€‚Wayland å¹¶ä¸æ˜¯é€šè¿‡ä¸€ä¸ª API è®©å®¢æˆ·ç«¯ä¸»åŠ¨æŸ¥è¯¢æœåŠ¡å™¨çŠ¶æ€å’Œç¯å¢ƒï¼Œè€Œæ˜¯é€šè¿‡ **registry** æ¥ä¸»åŠ¨é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ—¢åŒ…æ‹¬å¯åŠ¨æ—¶çš„ç¯å¢ƒä¿¡æ¯ï¼Œä¹ŸåŒ…æ‹¬ä¹‹åçš„åŠ¨æ€å˜åŒ–ï¼ˆæ¯”å¦‚æ–°æ˜¾ç¤ºå™¨çš„æ’å…¥ï¼‰ã€‚å› æ­¤ï¼ŒWayland å¤©ç”Ÿå°±æ˜¯ **çƒ­æ’æ‹”é©±åŠ¨çš„ï¼ˆhotplug-basedï¼‰**ã€‚åŒæ—¶ï¼Œè¿™ä¹Ÿæ˜¯å®¢æˆ·ç«¯è·çŸ¥æœåŠ¡å™¨æ”¯æŒå“ªäº›æ‰©å±•ã€å“ªäº›ç‰ˆæœ¬çš„æ–¹å¼ã€‚

æ³¨å†Œè¡¨é€šè¿‡ **wl_registry.global** äº‹ä»¶å¹¿æ’­æ–°çš„å…¨å±€å¯¹è±¡ï¼Œé€šè¿‡ **wl_registry.global_remove** äº‹ä»¶å¹¿æ’­å¯¹è±¡çš„ç§»é™¤ã€‚

ç›®å‰è¿™äº›ä¿¡æ¯åœ¨åç»­ä¼šå¾ˆæœ‰ç”¨ï¼Œä½†ç°åœ¨æˆ‘ä»¬åªéœ€è¦åšç‚¹â€œé­”æ³•â€ï¼Œæ‹¿åˆ°å‡ ä¸ªå¿…é¡»çš„å…¨å±€å¯¹è±¡ï¼š

```c
#include <stdio.h>
#include <string.h>
#include <wayland-client.h>

struct wl_compositor *compositor;
struct wl_shm *shm;
struct wl_shell *shell;

void registry_global_handler
(
    void *data,
    struct wl_registry *registry,
    uint32_t name,
    const char *interface,
    uint32_t version
) {
    if (strcmp(interface, "wl_compositor") == 0) {
        compositor = wl_registry_bind(registry, name,
            &wl_compositor_interface, 3);
    } else if (strcmp(interface, "wl_shm") == 0) {
        shm = wl_registry_bind(registry, name,
            &wl_shm_interface, 1);
    } else if (strcmp(interface, "wl_shell") == 0) {
        shell = wl_registry_bind(registry, name,
            &wl_shell_interface, 1);
    }
}
```

è¿™é‡Œ `wl_registry.global` ä¼ å…¥çš„ â€œnameâ€ è¿˜ä¸æ˜¯å¯¹è±¡çš„çœŸæ­£ IDï¼Œæˆ‘ä»¬éœ€è¦ç”¨ **wl_registry_bind()** æ¥è¿›è¡Œç»‘å®šï¼Œç”Ÿæˆå®é™…çš„å¯¹è±¡ã€‚ç”±äºå®ƒéœ€è¦åˆ›å»ºç±»å‹åœ¨ç¼–è¯‘æœŸæœªçŸ¥çš„æ–°å¯¹è±¡ï¼Œæ‰€ä»¥ `wayland-client` çš„å‡½æ•°ç­¾åå’Œåº•å±‚çš„ `wl_registry.bind` è¯·æ±‚ç•¥æœ‰ä¸åŒã€‚

æŠŠ **registry_listener** çš„å®šä¹‰ç§»å‡º `main()`ï¼š

```c
void registry_global_remove_handler
(
    void *data,
    struct wl_registry *registry,
    uint32_t name
) {}

const struct wl_registry_listener registry_listener = {
    .global = registry_global_handler,
    .global_remove = registry_global_remove_handler
};
```

æ¥ç€åœ¨ `main()` ä¸­ç­‰å¾…å…¨å±€äº‹ä»¶çš„åˆå§‹åŒ–é€šçŸ¥ï¼š

```c
int main(void)
{
    struct wl_display *display = wl_display_connect(NULL);
    struct wl_registry *registry = wl_display_get_registry(display);
    wl_registry_add_listener(registry, &registry_listener, NULL);

    // ç­‰å¾…â€œåˆå§‹â€çš„å…¨å±€å¯¹è±¡å‡ºç°
    wl_display_roundtrip(display);

    // æˆ‘ä»¬éœ€è¦çš„å¯¹è±¡åº”è¯¥å·²ç»å°±ç»ªï¼
    if (compositor && shm && shell) {
        printf("Got them all!\n");
    } else {
        printf("Some required globals unavailable\n");
        printf("compositor:%p, shm:%p, shell:%p\n", compositor, shm, shell);
        return 1;
    }

    while (1) {
        wl_display_dispatch(display);
    }
}
```

è¿™é‡Œçš„ **wl_display_roundtrip**ï¼ˆå®ƒä¸æ˜¯ `wl_display` çš„è¯·æ±‚ï¼Œè€Œæ˜¯ä¸€ä¸ª wayland-client æä¾›çš„ç‰¹æ®Šå‡½æ•°ï¼Œåº•å±‚ç”¨çš„æ˜¯ `wl_display.sync` è¯·æ±‚ï¼‰ä¼šé˜»å¡å®¢æˆ·ç«¯ï¼Œç›´åˆ°æ‰€æœ‰æŒ‚èµ·çš„æ–¹æ³•ï¼ˆè¯·æ±‚å’Œäº‹ä»¶ï¼‰éƒ½å®Œæˆï¼Œä¸”æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨éƒ½æ‰§è¡Œå®Œæ¯•ã€‚

ç¼–è¯‘å¹¶è¿è¡Œï¼š

```bash
$ gcc main.c -l wayland-client -o runme
$ ./runme
Some required globals unavailable
compositor:0x558d1346a470, shm:0x558d1346a640, shell:(nil)
```

å¤‡æ³¨ï¼š
+ wl_shell æ›¾ç»æ˜¯ Wayland ä¸Šç®¡ç†çª—å£è§’è‰²ï¼ˆtoplevelã€popup ç­‰ï¼‰çš„æ¥å£ã€‚
+ åæ¥ç¤¾åŒºå‘ç°å®ƒè®¾è®¡ä¸åˆç†ï¼Œåè®®è¢«å†»ç»“å¹¶è¢« xdg_shell å–ä»£ã€‚
+ æ–° compositor ä¸ä¼šå†å‘å®¢æˆ·ç«¯å…¬å¼€ wl_shellï¼Œæ‰€ä»¥ wl_registry éå†æ—¶æ‹¿ä¸åˆ°å®ƒ â†’ (nil)ã€‚

å¾ˆå¥½ï¼ğŸ‰